<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QRコードタイムレコーダー</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dexie/3.2.2/dexie.min.js"></script>
</head>
<body>
    <div class="container mt-5">
        <center><h1 class="mb-4">QRコードタイムレコーダー</h1></center>
        <div class="row">
            <div class="col-md-3 mb-3">
                <div class="card">
                    <div class="card-body">
                        <button class="btn btn-primary w-100" data-bs-toggle="modal" data-bs-target="#registerModal">メンバー登録</button>
                        <p class="mt-2 small text-muted">新しいメンバーを登録します。名前、性別、メモを入力し、登録完了後、個別のQRコードを生成し表示します。QRコードは、画像ファイルそのまま、又は、IDカードに印刷して新しいメンバーに渡して下さい。</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="card">
                    <div class="card-body">
                        <button class="btn btn-success w-100" onclick="startScan('in')">IN</button>
                        <p class="mt-2 small text-muted">入場時刻を記録します。メンバーのQRコードをスキャンして、現在時刻を入場時刻として記録します。登録されていないメンバー、又は、不正なQRコードでは打刻されません。</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="card">
                    <div class="card-body">
                        <button class="btn btn-danger w-100" onclick="startScan('out')">OUT</button>
                        <p class="mt-2 small text-muted">退場時刻を記録します。メンバーのQRコードをスキャンして、現在時刻を退場時刻として記録します。登録されていないメンバー、又は、不正なQRコードでは打刻されません。</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="card">
                    <div class="card-body">
                        <button class="btn btn-info w-100" data-bs-toggle="modal" data-bs-target="#userListModal">メンバー一覧</button>
                        <p class="mt-2 small text-muted">登録済みの全メンバーを表示します。メンバーの情報を編集したり、削除したりすることができます。（メンバーを削除した場合、そのメンバーの打刻記録も同時に削除されます。）複数ワードでの検索も可能です。</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="card">
                    <div class="card-body">
                        <button class="btn btn-warning w-100" data-bs-toggle="modal" data-bs-target="#timeLogModal">打刻一覧</button>
                        <p class="mt-2 small text-muted">記録された全ての打刻情報を表示します。日時、メンバー名、入場/退場の種類、メンバーの詳細が確認できます。（打刻記録を全件削除した場合でも、登録済みのメンバー情報は全件保持されます。）複数ワードでの検索も可能です。</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="card">
                    <div class="card-body">
                        <button class="btn btn-secondary w-100" onclick="exportData()">エクスポート</button>
                        <p class="mt-2 small text-muted">全てのデータをJSONファイルとして保存します。メンバー情報と打刻記録が含まれます。</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="card">
                    <div class="card-body">
                        <input type="file" id="importFile" style="display: none;" onchange="importData(event)">
                        <button class="btn btn-secondary w-100" onclick="document.getElementById('importFile').click()">インポート</button>
                        <p class="mt-2 small text-muted">保存したJSONファイルからデータを読み込みます。既存のデータは上書きされます。</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="card">
                    <div class="card-body">
                        <button class="btn btn-secondary w-100" onclick="resetData()">リセット</button>
                        <p class="mt-2 small text-muted">全てのデータを完全に削除します。メンバー情報と打刻記録が全て消去されるので注意してください。</p>
                    </div>
                </div>
            </div>
        </div>
    </div>


    <!-- 登録モーダル -->
    <div class="modal fade" id="registerModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">新規登録</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="registerForm">
                        <div class="mb-3">
                            <label for="name" class="form-label">名前</label>
                            <input type="text" class="form-control" id="name" required>
                        </div>
                        <div class="mb-3">
                            <label for="gender" class="form-label">性別</label>
                            <select class="form-select" id="gender" required>
                                <option value="">選択してください</option>
                                <option value="男性">男性</option>
                                <option value="女性">女性</option>
                                <option value="その他">その他</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="memo" class="form-label">メモ</label>
                            <textarea class="form-control" id="memo" rows="3"></textarea>
                        </div>
                        <button type="submit" class="btn btn-primary">登録</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- QRコードモーダル -->
    <div class="modal fade" id="qrcodeModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">QRコード</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="qrcode"></div> <!-- QRコード表示エリア -->
                </div>
            </div>
        </div>
    </div>

    <!-- スキャンモーダル -->
    <div class="modal fade" id="scanModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">QRコードスキャン</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="reader"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- 使用者一覧モーダル -->
    <div class="modal fade" id="userListModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">メンバー一覧</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="text" id="userSearchInput" class="form-control mb-3" placeholder="検索 (複数のワードで検索できます)">
                    <table class="table">
                        <thead>
                            <tr>
                                <th style="white-space: nowrap;">ID</th>
                                <th style="white-space: nowrap;">名前</th>
                                <th style="white-space: nowrap;">性別</th>
                                <th>メモ</th>
                                <th style="white-space: nowrap;">操作</th>
                            </tr>
                        </thead>
                        <tbody id="userListBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- 編集モーダル -->
    <div class="modal fade" id="editUserModal" tabindex="-1" style="background-color: rgba(79, 79, 79, 0.5);">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">メンバー編集</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="editUserForm">
                        <input type="hidden" id="editUserId">
                        <div class="mb-3">
                            <label for="editName" class="form-label">名前</label>
                            <input type="text" class="form-control" id="editName" required>
                        </div>
                        <div class="mb-3">
                            <label for="editGender" class="form-label">性別</label>
                            <select class="form-select" id="editGender" required>
                                <option value="">選択してください</option>
                                <option value="男性">男性</option>
                                <option value="女性">女性</option>
                                <option value="その他">その他</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="editMemo" class="form-label">メモ</label>
                            <textarea class="form-control" id="editMemo" rows="3"></textarea>
                        </div>
                        <button type="submit" class="btn btn-primary">保存</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

<!-- 打刻一覧モーダル -->
<div class="modal fade" id="timeLogModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">打刻一覧</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <button class="btn btn-danger" onclick="deleteAllTimeLogs()">全件削除</button><br><br>
                <input type="text" id="timeLogSearchInput" class="form-control mb-3" placeholder="検索 (複数のワードで検索できます)">
                <table class="table">
                    <thead>
                        <tr>
                            <th>名前</th>
                            <th>日時</th>
                            <th>種類</th>
                        </tr>
                    </thead>
                    <tbody id="timeLogBody"></tbody>
                </table>
            </div>
        </div>
    </div>
</div>


<div class="modal fade" id="userDetailsModal" tabindex="-1" style="background-color: rgba(79, 79, 79, 0.5);">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">メンバー詳細</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <!-- 詳細情報が表示されるエリア -->
            </div>
        </div>
    </div>
</div>



    <script>

        window.addEventListener('storage', (event) => {
        if (event.key === 'indexedDBQuotaExceeded') {
            // ストレージの空き容量が少なくなった場合の処理
            alert('取り扱い可能なのデータ容量が上限に迫っています。現行のデータをエクスポートし、打刻情報を全件削除してからご利用下さい。メンバー登録件数の最適化（存在しないメンバーは削除）をお勧めします。エクスポートしたデータは検索用として引き続き利用できます。');
        }
        });

        // データベース初期化
        const db = new Dexie('TimeRecorderDB');
        db.version(1).stores({
            users: '++id,name,gender,memo',
            timeLogs: '++id,userId,name,timestamp,type'
        });

        db.open().catch((err) => {
            console.error(err.stack || err);
        });

    document.getElementById('registerForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const name = document.getElementById('name').value;
    const gender = document.getElementById('gender').value;
    const memo = document.getElementById('memo').value;
    const userId = await db.users.add({ name, gender, memo });
    alert('登録が完了しました。');
    document.getElementById('registerForm').reset();
    const registerModal = bootstrap.Modal.getInstance(document.getElementById('registerModal'));
    registerModal.hide();

    // QRコードを生成して表示
    const qrcodeModal = new bootstrap.Modal(document.getElementById('qrcodeModal'));
    const qrcodeElement = document.getElementById('qrcode');
    qrcodeElement.innerHTML = ''; // 既存のQRコードをクリア

    const qrCode = new QRCode(qrcodeElement, {
        text: userId.toString(),
        width: 256,
        height: 256
    });

    // QRコードが生成されるまで待つ
    setTimeout(() => {
        // 生成されたQRコード画像を取得
        const qrCodeImg = qrcodeElement.querySelector('img');

        // キャンバスを作成して余白を追加
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        const size = 256;
        const padding = 20;
        canvas.width = size + padding * 2;
        canvas.height = size + padding * 2;

        const img = new Image();
        img.onload = () => {
            ctx.fillStyle = 'white';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            ctx.drawImage(img, padding, padding, size, size);

            // ダウンロードリンクを追加
            const downloadLink = document.createElement('a');
            downloadLink.href = canvas.toDataURL('image/png');
            downloadLink.download = `qrcode_${userId}.png`;
            downloadLink.textContent = 'QRコードをダウンロード';
            qrcodeElement.appendChild(downloadLink);
        };
        img.src = qrCodeImg.src;
    }, 500);

    qrcodeModal.show();
});


        document.getElementById('registerModal').addEventListener('hidden.bs.modal', () => {
            document.getElementById('registerForm').reset();
        });

        function startScan(type) {
    let html5QrcodeScanner;
    const scanModal = new bootstrap.Modal(document.getElementById('scanModal'));
    scanModal.show();

    const readerElement = document.getElementById('reader');
    readerElement.innerHTML = ''; // 既存のコンテンツをクリア

    html5QrcodeScanner = new Html5Qrcode("reader");
    html5QrcodeScanner.start(
        { facingMode: "environment" },
        {
            fps: 30,
            qrbox: 300
        },
        async (decodedText) => {
            html5QrcodeScanner.stop();
            scanModal.hide();

            try {
                // QRコードの内容を数値に変換
                const id = parseInt(decodedText);

                // 数値に変換できない場合、エラーをスロー
                if (isNaN(id)) {
                    scanModal._element.addEventListener('hidden.bs.modal', () => {
                        alert('不正なQRコードです。');
                        // アラートが閉じられたらリロード
                        window.location.reload();
                    }, { once: true });
                    return;
                }

                const user = await db.users.get(id);

                if (user) {
                    const timestamp = new Date().toLocaleString('ja-JP');
                    await db.timeLogs.add({ userId: id, name: user.name, timestamp, type });
                    alert(`${user.name} さんの ${type === 'in' ? '出勤' : '退勤'} が記録されました。`);
                    // アラートが閉じられたらリロード
                    window.location.reload();
                } else {
                    scanModal._element.addEventListener('hidden.bs.modal', () => {
                        alert('登録されていないメンバーです。');
                        // アラートが閉じられたらリロード
                        window.location.reload();
                    }, { once: true });
                }
            } catch (error) {
                scanModal._element.addEventListener('hidden.bs.modal', () => {
                    alert(error.message);
                    // アラートが閉じられたらリロード
                    window.location.reload();
                }, { once: true });
            }
        },
        (errorMessage) => {
            // QRコード読み取りに失敗した場合の処理
        }
    ).catch((err) => {
        // カメラの初期化に失敗した場合の処理
        console.error(err);
    });

    // モーダルを閉じたときにカメラを停止
    scanModal._element.addEventListener('hidden.bs.modal', () => {
        if (html5QrcodeScanner) {
            html5QrcodeScanner.stop().catch(err => console.error(err));
        }
        // モーダルが閉じられたらリロード
        window.location.reload();
    });
}



// 使用者一覧を表示
function renderUserList(users) {
    const userListBody = document.getElementById('userListBody');
    userListBody.innerHTML = '';
    users.forEach(user => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td style="white-space: nowrap;">${user.id}</td>
            <td style="white-space: nowrap;">${user.name}</td>
            <td style="white-space: nowrap;">${user.gender}</td>
            <td>${user.memo.replace(/\n/g, '<br>')}</td>
            <td style="white-space: nowrap;">
                <button class="btn btn-primary btn-sm" onclick="editUser(${user.id})">編集</button>
                <button class="btn btn-danger btn-sm" onclick="deleteUser(${user.id})">削除</button>
            </td>
        `;
        userListBody.appendChild(tr);
    });
}


// 使用者一覧を検索
document.getElementById('userSearchInput').addEventListener('input', async (e) => {
    const query = e.target.value.toLowerCase();
    const users = await db.users.toArray();
    const searchTerms = query.split(/\s+/); // 半角スペースまたは全角スペースで分割
    const filteredUsers = users.filter(user => {
        return searchTerms.every(term => {
            return user.name.toLowerCase().includes(term) ||
                   user.gender.toLowerCase().includes(term) ||
                   user.memo.toLowerCase().includes(term);
        });
    });
    renderUserList(filteredUsers);
});

        // 使用者一覧モーダルが表示されたときに使用者一覧を表示
        document.getElementById('userListModal').addEventListener('shown.bs.modal', async () => {
            const users = await db.users.toArray();
            renderUserList(users);
        });

        // 使用者を編集
        async function editUser(id) {
            const user = await db.users.get(id);
            if (user) {
                document.getElementById('editUserId').value = user.id;
                document.getElementById('editName').value = user.name;
                document.getElementById('editGender').value = user.gender;
                document.getElementById('editMemo').value = user.memo;
                const editUserModal = new bootstrap.Modal(document.getElementById('editUserModal'));
                editUserModal.show();
            }
        }

        // 編集された使用者を保存
        document.getElementById('editUserForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = parseInt(document.getElementById('editUserId').value);
            const name = document.getElementById('editName').value;
            const gender = document.getElementById('editGender').value;
            const memo = document.getElementById('editMemo').value;
            await db.users.update(id, { name, gender, memo });
            alert('更新が完了しました。');
            document.getElementById('editUserForm').reset();
            const editUserModal = bootstrap.Modal.getInstance(document.getElementById('editUserModal'));
            editUserModal.hide();
            const users = await db.users.toArray();
            renderUserList(users);
        });

// 使用者を削除
async function deleteUser(id) {
    if (confirm('本当に削除しますか？関連する打刻情報も削除されます...')) {
        // 関連する打刻情報を削除
        await db.timeLogs.where('userId').equals(id).delete();
        // 使用者を削除
        await db.users.delete(id);
        const users = await db.users.toArray();
        renderUserList(users);
    }
}

// 打刻一覧を表示
function renderTimeLogList(timeLogs) {
    const timeLogBody = document.getElementById('timeLogBody');
    timeLogBody.innerHTML = '';
    timeLogs.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
    timeLogs.forEach(log => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td>${log.name}</td>
            <td>${log.timestamp}</td>
            <td>${log.type === 'in' ? '入場' : '退場'}</td>
            <td><button class="btn btn-info btn-sm" onclick="showUserDetails(${log.userId})">詳細</button></td>
        `;
        timeLogBody.appendChild(tr);
    });
}

// 打刻一覧を全件削除
async function deleteAllTimeLogs() {
    if (confirm('全ての打刻情報を削除しますか？登録されているメンバーは削除されません。')) {
        await db.timeLogs.clear();
        alert('打刻情報が全て削除されました。');
        const timeLogs = await db.timeLogs.toArray();
        renderTimeLogList(timeLogs); // 削除後に一覧を再描画
    }
}

// 打刻者の詳細情報を表示するモーダル
async function showUserDetails(userId) {
    const user = await db.users.get(userId);
    if (user) {
        const detailsModal = new bootstrap.Modal(document.getElementById('userDetailsModal'));
        const modalBody = detailsModal._element.querySelector('.modal-body');
        modalBody.innerHTML = `
            <p><strong>名前:</strong> ${user.name}</p>
            <p><strong>性別:</strong> ${user.gender}</p>
            <p><strong>メモ:</strong><br> ${user.memo.replace(/\n/g, '<br>')} </p>
        `;
        detailsModal.show();
    }
}

// 打刻一覧を検索
document.getElementById('timeLogSearchInput').addEventListener('input', async (e) => {
    const query = e.target.value.toLowerCase();
    const timeLogs = await db.timeLogs.toArray();
    const searchTerms = query.split(/\s+/); // 半角スペースまたは全角スペースで分割
    const filteredLogs = timeLogs.filter(log => {
        return searchTerms.every(term => {
            return log.name.toLowerCase().includes(term) ||
                   log.timestamp.toLowerCase().includes(term) ||
                   (log.type === 'in' ? '出勤' : '退勤').toLowerCase().includes(term);
        });
    });
    renderTimeLogList(filteredLogs);
});



        // 打刻一覧モーダルが表示されたときに打刻一覧を表示
        document.getElementById('timeLogModal').addEventListener('shown.bs.modal', async () => {
            const timeLogs = await db.timeLogs.toArray();
            renderTimeLogList(timeLogs);
        });

        // データのエクスポート
        async function exportData() {
            const users = await db.users.toArray();
            const timeLogs = await db.timeLogs.toArray();
            const data = { users, timeLogs };
            const blob = new Blob([JSON.stringify(data)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'timerecorder_data.json';
            a.click();
            URL.revokeObjectURL(url);
        }

        // データのインポート
        async function importData(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = async (e) => {
                    const data = JSON.parse(e.target.result);
                    await db.users.clear();
                    await db.timeLogs.clear();
                    await db.users.bulkAdd(data.users);
                    await db.timeLogs.bulkAdd(data.timeLogs);
                    alert('データのインポートが完了しました。');
                };
                reader.readAsText(file);
            }
        }

        // データのリセット
        async function resetData() {
            if (confirm('全てのデータをリセットしますか？')) {
                await db.users.clear();
                await db.timeLogs.clear();
                alert('データがリセットされました。');
            }
        }
    </script>
</body>
</html>